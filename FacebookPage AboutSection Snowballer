import facebook
graph = facebook.GraphAPI(access_token='yourAppID|YourAppSecret', version='2.7')

import csv
snowball = []
edges = []
Indicators = []
attributes = []
seen_nodes = []

with open('/Users/anders/Downloads/SeedList_AirPollution_FacebookPages - Indicators.csv') as csvfile:
    indicator_list = csv.reader(csvfile)
    for row in indicator_list:
        Indicators.append(row[0])
    

with open('/Users/anders/Downloads/SeedList_AirPollution_FacebookPages - TestSet.csv') as csvfile:
    seedlist = csv.reader(csvfile)
    
    for row in seedlist:
        print(row)
        token = row[0] + '?fields=likes.limit(100){location,about,name,category},name,id,location,category'
        try:
            likes = graph.get_object(id=token)
            if likes['id'] not in seen_nodes:
                ID = likes['id']
                seen_nodes.append(ID)
                if 'location' in likes:
                    if 'country' in likes['location']:
                        country = likes['location']['country']
                    else:
                        country = 'NA'
                    if 'city' in likes['location']:
                        city = likes['location']['city']
                    else:
                        city = 'NA'
                    if 'latitude' in likes['location']:
                        lat = likes['location']['latitude']
                    else:
                        lat = 'NA'
                    if 'longitude' in likes['location']:
                        lon = likes['location']['longitude']
                    else:
                        lon = 'NA'
                else:
                    country = 'NA'
                    city = 'NA'
                    lat = 'NA'
                    lon = 'NA'
                if 'about' in likes:
                    about = likes['about']
                else:
                    about = 'NA'
                if 'category' in likes:
                    category = likes['category']
                else:
                    category = NA
                if 'name' in likes:
                    name = likes['name']
                else:
                    name = 'NA'
                link = 'www.facebook.com/' + likes['id']
                node = {'id':ID,'name':name,'category':category,'about':about,'link':link,'country':country,'city':city,'lat':lat,'lon':lon}
                attributes.append(node)
            paging = likes['likes']['paging']
            if 'likes' in likes:
                if 'data' in likes['likes']:
                    for like in likes['likes']['data']:
                        if 'about' in like:
                            relevance = 0
                            for indicator in Indicators:
                                if like['about'].lower().find(indicator) > 0:
                                    relevance = relevance + 1

                            if relevance > 0 and like['id'] not in snowball:
                                snowball.append(like['id'])
                                edge = {int(row[0]),like['id']} 
                                edges.append(edge)
                                print('found')
                                if like['id'] not in seen_nodes:
                                    ID = like['id']
                                    seen_nodes.append(ID)
                                    if 'location' in like:
                                        if 'country' in like['location']:
                                            country = like['location']['country']
                                        else:
                                            country = 'NA'
                                        if 'city' in like['location']:
                                            city = like['location']['city']
                                        else:
                                            city = 'NA'
                                        if 'latitude' in like['location']:
                                            lat = like['location']['latitude']
                                        else:
                                            lat = 'NA'
                                        if 'longitude' in like['location']:
                                            lon = like['location']['longitude']
                                        else:
                                            lon = 'NA'
                                    else:
                                        country = 'NA'
                                        city = 'NA'
                                        lat = 'NA'
                                        lon = 'NA'
                                    if 'about' in like:
                                        about = like['about']
                                    else:
                                        about = 'NA'
                                    if 'category' in like:
                                        category = like['category']
                                    else:
                                        category = NA
                                    if 'name' in like:
                                        name = like['name']
                                    else:
                                        name = 'NA'
                                    link = 'www.facebook.com/' + like['id']
                                    node = {'id':ID,'name':name,'category':category,'about':about,'link':link,'country':country,'city':city,'lat':lat,'lon':lon}
                                    attributes.append(node)

                    while 'next' in paging:
                        print('paging')
                        nexttoken = row[0] + '/likes?access_token=1446618168730188%7CsK4hOvFJ1Hby65ZYO8b-aR2jcP4&fields=location%2Cabout%2Cname%2Ccategory&limit=100&after=' + likes['likes']['paging']['cursors']['after']
                        likes = graph.get_object(id=nexttoken)
                        paging = likes['paging']
                        for like in likes['data']:
                            if 'about' in like:
                                relevance = 0
                                for indicator in Indicators:
                                    if like['about'].lower().find(indicator) > 0:
                                        relevance = relevance + 1

                                if relevance > 0 and like['id'] not in snowball:
                                    snowball.append(like['id'])
                                    edge = {int(row[0]),like['id']} 
                                    edges.append(edge)
                                    print('found')
                                    if like['id'] not in seen_nodes:
                                        ID = like['id']
                                        seen_nodes.append(ID)
                                        if 'location' in like:
                                            if 'country' in like['location']:
                                                country = like['location']['country']
                                            else:
                                                country = 'NA'
                                            if 'city' in like['location']:
                                                city = like['location']['city']
                                            else:
                                                city = 'NA'
                                            if 'latitude' in like['location']:
                                                lat = like['location']['latitude']
                                            else:
                                                lat = 'NA'
                                            if 'longitude' in like['location']:
                                                lon = like['location']['longitude']
                                            else:
                                                lon = 'NA'
                                        else:
                                            country = 'NA'
                                            city = 'NA'
                                            lat = 'NA'
                                            lon = 'NA'
                                        if 'about' in like:
                                            about = like['about']
                                        else:
                                            about = 'NA'
                                        if 'category' in like:
                                            category = like['category']
                                        else:
                                            category = NA
                                        if 'name' in like:
                                            name = like['name']
                                        else:
                                            name = 'NA'
                                        link = 'www.facebook.com/' + like['id']
                                        node = {'id':ID,'name':name,'category':category,'about':about,'link':link,'country':country,'city':city,'lat':lat,'lon':lon}
                                        attributes.append(node)
                    print('seed done')

        except:
            print('skipping')
    
    print('NOW SNOWBALLING')
    
    for page in snowball:
        print(page)
        token = page + '?fields=likes.limit(100){location,about,name,category},name,id,location,category'
        try:
            likes = graph.get_object(id=token)
            paging = likes['likes']['paging']
            if likes['id'] not in seen_nodes:
                ID = likes['id']
                seen_nodes.append(ID)
                if 'location' in likes:
                    if 'country' in likes['location']:
                        country = likes['location']['country']
                    else:
                        country = 'NA'
                    if 'city' in likes['location']:
                        city = likes['location']['city']
                    else:
                        city = 'NA'
                    if 'latitude' in likes['location']:
                        lat = likes['location']['latitude']
                    else:
                        lat = 'NA'
                    if 'longitude' in likes['location']:
                        lon = likes['location']['longitude']
                    else:
                        lon = 'NA'
                else:
                    country = 'NA'
                    city = 'NA'
                    lat = 'NA'
                    lon = 'NA'
                if 'about' in likes:
                    about = likes['about']
                else:
                    about = 'NA'
                if 'category' in likes:
                    category = likes['category']
                else:
                    category = NA
                if 'name' in likes:
                    name = likes['name']
                else:
                    name = 'NA'
                link = 'www.facebook.com/' + likes['id']
                node = {'id':ID,'name':name,'category':category,'about':about,'link':link,'country':country,'city':city,'lat':lat,'lon':lon}
                attributes.append(node)
            
            if 'likes' in likes:
                if 'data' in likes['likes']:
                    for like in likes['likes']['data']:
                        if 'about' in like:
                            relevance = 0
                            for indicator in Indicators:
                                if like['about'].lower().find(indicator) > 0:
                                    relevance = relevance + 1
                            
                            if relevance > 0 and like['id'] not in snowball:
                                snowball.append(like['id'])
                                print('found')
                                edge = {page,like['id']} 
                                edges.append(edge)
                                if like['id'] not in seen_nodes:
                                    ID = like['id']
                                    seen_nodes.append(ID)
                                    if 'location' in like:
                                        if 'country' in like['location']:
                                            country = like['location']['country']
                                        else:
                                            country = 'NA'
                                        if 'city' in like['location']:
                                            city = like['location']['city']
                                        else:
                                            city = 'NA'
                                        if 'latitude' in like['location']:
                                            lat = like['location']['latitude']
                                        else:
                                            lat = 'NA'
                                        if 'longitude' in like['location']:
                                            lon = like['location']['longitude']
                                        else:
                                            lon = 'NA'
                                    else:
                                        country = 'NA'
                                        city = 'NA'
                                        lat = 'NA'
                                        lon = 'NA'
                                    if 'about' in like:
                                        about = like['about']
                                    else:
                                        about = 'NA'
                                    if 'category' in like:
                                        category = like['category']
                                    else:
                                        category = NA
                                    if 'name' in like:
                                        name = like['name']
                                    else:
                                        name = 'NA'
                                    link = 'www.facebook.com/' + like['id']
                                    node = {'id':ID,'name':name,'category':category,'about':about,'link':link,'country':country,'city':city,'lat':lat,'lon':lon}
                                    attributes.append(node)
                            
                    while 'next' in paging:
                        print('paging')
                        nexttoken = row[0] + '/likes?access_token=1446618168730188%7CsK4hOvFJ1Hby65ZYO8b-aR2jcP4&fields=location%2Cabout%2Cname%2Ccategory&limit=100&after=' + likes['likes']['paging']['cursors']['after']
                        likes = graph.get_object(id=nexttoken)
                        paging = likes['paging']
                        for like in likes['data']:
                            if 'about' in like:
                                relevance = 0
                                for indicator in Indicators:
                                    if like['about'].lower().find(indicator) > 0:
                                        relevance = relevance + 1

                                if relevance > 0 and like['id'] not in snowball:
                                    snowball.append(like['id'])
                                    print('found')
                                    edge = {page,like['id']} 
                                    edges.append(edge)
                                    if like['id'] not in seen_nodes:
                                        ID = like['id']
                                        seen_nodes.append(ID)
                                        if 'location' in like:
                                            if 'country' in like['location']:
                                                country = like['location']['country']
                                            else:
                                                country = 'NA'
                                            if 'city' in like['location']:
                                                city = like['location']['city']
                                            else:
                                                city = 'NA'
                                            if 'latitude' in like['location']:
                                                lat = like['location']['latitude']
                                            else:
                                                lat = 'NA'
                                            if 'longitude' in like['location']:
                                                lon = like['location']['longitude']
                                            else:
                                                lon = 'NA'
                                        else:
                                            country = 'NA'
                                            city = 'NA'
                                            lat = 'NA'
                                            lon = 'NA'
                                        if 'about' in like:
                                            about = like['about']
                                        else:
                                            about = 'NA'
                                        if 'category' in like:
                                            category = like['category']
                                        else:
                                            category = NA
                                        if 'name' in like:
                                            name = like['name']
                                        else:
                                            name = 'NA'
                                        link = 'www.facebook.com/' + like['id']
                                        node = {'id':ID,'name':name,'category':category,'about':about,'link':link,'country':country,'city':city,'lat':lat,'lon':lon}
                                        attributes.append(node)
                    print('seed done')
        except:
            print('skipping')
print('harvest complete')

#build network
import networkx
Graph = networkx.DiGraph()

Graph.add_edges_from(edges)

for i in attributes:
    if i['id'] in Graph:
        Graph.node[i['id']]['about'] = i['about']
        Graph.node[i['id']]['category'] = i['category']
        Graph.node[i['id']]['city'] = i['city']
        Graph.node[i['id']]['country'] = i['country']
        Graph.node[i['id']]['id'] = i['id']
        Graph.node[i['id']]['lat'] = i['lat']
        Graph.node[i['id']]['lon'] = i['lon']
        Graph.node[i['id']]['link'] = i['link']
        Graph.node[i['id']]['name'] = i['name']

networkx.write_gexf(Graph, '/Users/anders/Downloads/PageSnowball_AirPollution.gexf', encoding='utf8')
print('done')
